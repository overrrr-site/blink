# AIサジェスション機能の強化計画

## 概要
カルテ作成時にAIがより賢い提案をする機能を強化する。
現在は「レポート下書き」と「耳の汚れ連続警告」のみの簡易的な実装。

---

## 現状分析

### 既存のサジェスション
1. `report-draft` - レポート文が空のときにAI生成を促す
2. `health-history` - グルーミングで耳の汚れが2回連続の場合に警告

### 課題
- サジェスションの種類が少ない
- 過去データの活用が不十分
- 業種別の最適化がされていない

---

## 追加するサジェスション機能

### 1. 体重変動アラート（grooming）
- 前回比で±10%以上の体重変化を検出
- 「体重が前回より○○%増加しています」

### 2. 久しぶりの来店アラート（全業種）
- 30日以上来店がない場合
- 「○日ぶりのご来店です」

### 3. 前回の気になる点フォローアップ（全業種）
- 前回のカルテに `concerns` 写真や内部メモがあった場合
- 「前回、○○が気になると記録されていました」

### 4. 誕生日サジェスション（全業種）
- 犬の誕生日が7日以内の場合
- 「○○ちゃんの誕生日が近いです！」

### 5. トレーニング進捗サマリー（daycare）
- 過去5回の記録から成長している項目を抽出
- 「オスワリが5回連続でできています！」

### 6. 健康チェック異常パターン（grooming）
- 耳以外にも爪、皮膚、歯で異常が連続している場合
- 既存の耳の汚れチェックを拡張

### 7. ホテル滞在日数に応じた提案（hotel）
- 2泊以上の滞在時にテンプレート提案
- 「長期滞在です。お食事や睡眠の様子を記録しましょう」

---

## 実装ファイル

### バックエンド
| ファイル | 変更内容 |
|----------|----------|
| `server/src/routes/ai.ts` | `/ai/suggestions/:recordId` エンドポイントのロジック拡張 |

### フロントエンド
| ファイル | 変更内容 |
|----------|----------|
| `client/src/types/ai.ts` | 新しいサジェスションタイプの追加 |
| `client/src/pages/RecordDetail.tsx` | 新サジェスションの状態管理追加 |

---

## 詳細実装

### バックエンド: `/ai/suggestions/:recordId` 拡張

```typescript
// 追加クエリ
// 1. 前回の記録を取得
const prevRecordQuery = `
  SELECT * FROM records
  WHERE dog_id = $1 AND store_id = $2 AND id <> $3
  AND deleted_at IS NULL
  ORDER BY record_date DESC
  LIMIT 1
`;

// 2. 犬の情報を取得（誕生日チェック用）
const dogQuery = `
  SELECT d.name, d.birth_date FROM dogs d WHERE d.id = $1
`;

// 3. トレーニング履歴（daycare用）
const trainingHistoryQuery = `
  SELECT daycare_data FROM records
  WHERE dog_id = $1 AND record_type = 'daycare'
  AND deleted_at IS NULL
  ORDER BY record_date DESC
  LIMIT 5
`;
```

### サジェスション生成ロジック追加

```typescript
// 1. 体重変動チェック（grooming）
if (record.record_type === 'grooming') {
  const currentWeight = record.health_check?.weight;
  const prevWeight = prevRecord?.health_check?.weight;
  if (currentWeight && prevWeight) {
    const change = ((currentWeight - prevWeight) / prevWeight) * 100;
    if (Math.abs(change) >= 10) {
      suggestions.push({
        type: 'weight-change',
        message: `体重が前回より${change > 0 ? '+' : ''}${change.toFixed(1)}%変化しています`,
        actionLabel: '報告文に追記',
        variant: change > 10 ? 'warning' : 'default',
      });
    }
  }
}

// 2. 久しぶりの来店チェック（全業種）
if (prevRecord) {
  const daysSince = Math.floor(
    (new Date(record.record_date).getTime() - new Date(prevRecord.record_date).getTime())
    / (1000 * 60 * 60 * 24)
  );
  if (daysSince > 30) {
    suggestions.push({
      type: 'long-absence',
      message: `${daysSince}日ぶりのご来店です`,
      actionLabel: '報告文で触れる',
      variant: 'default',
    });
  }
}

// 3. 前回の気になる点フォローアップ
if (prevRecord?.photos?.concerns?.length > 0) {
  const concernLabel = prevRecord.photos.concerns[0]?.label || '気になる点';
  suggestions.push({
    type: 'follow-up',
    message: `前回「${concernLabel}」の記録がありました`,
    actionLabel: '今回の様子を確認',
    variant: 'warning',
  });
}

// 4. 誕生日チェック
const dog = dogResult.rows[0];
if (dog?.birth_date) {
  const today = new Date();
  const birthDate = new Date(dog.birth_date);
  const thisYearBirthday = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());
  const daysUntil = Math.floor((thisYearBirthday.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));

  if (daysUntil >= 0 && daysUntil <= 7) {
    suggestions.push({
      type: 'birthday',
      message: daysUntil === 0
        ? `今日は${dog.name}ちゃんのお誕生日です！🎂`
        : `${dog.name}ちゃんのお誕生日まであと${daysUntil}日です`,
      actionLabel: 'お祝いメッセージを追加',
      variant: 'success',
    });
  }
}

// 5. トレーニング進捗（daycare）
if (record.record_type === 'daycare' && trainingHistory.length >= 3) {
  // 連続で「done」になっている項目を検出
  const consistentItems = findConsistentTrainingItems(trainingHistory);
  if (consistentItems.length > 0) {
    suggestions.push({
      type: 'training-progress',
      message: `${consistentItems[0]}が${consistentItems.length > 1 ? 'など' : ''}連続でできています！`,
      actionLabel: '成長を報告文に追記',
      variant: 'success',
    });
  }
}

// 6. 健康チェック異常パターン拡張（grooming）
// 既存の耳チェックに加え、爪・皮膚・歯もチェック
const healthItems = ['ears', 'nails', 'skin', 'teeth'];
for (const item of healthItems) {
  const currentValue = record.health_check?.[item];
  const abnormalValues = ['汚れ', '伸びている', '異常あり', '要注意'];
  if (abnormalValues.includes(currentValue)) {
    const count = historyResult.rows.filter(r => abnormalValues.includes(r.health_check?.[item])).length;
    if (count >= 1) {
      suggestions.push({
        type: 'health-history',
        message: `${getHealthItemLabel(item)}の異常が連続しています`,
        actionLabel: '報告文に追記',
        variant: 'warning',
      });
      break; // 最初の1つだけ表示
    }
  }
}

// 7. ホテル長期滞在（hotel）
if (record.record_type === 'hotel' && record.hotel_data?.nights >= 2) {
  suggestions.push({
    type: 'long-stay',
    message: `${record.hotel_data.nights}泊の長期滞在です`,
    actionLabel: '滞在中の様子を詳しく記録',
    variant: 'default',
  });
}
```

---

## フロントエンド: 型定義更新

### client/src/types/ai.ts
```typescript
export type AISuggestionType =
  | 'report-draft'
  | 'health-history'
  | 'photo-concern'
  | 'weight-change'      // 追加
  | 'long-absence'       // 追加
  | 'birthday'           // 追加
  | 'follow-up'          // 追加
  | 'training-progress'  // 追加
  | 'long-stay';         // 追加
```

### RecordDetail.tsx 状態管理
```typescript
const [aiSuggestions, setAiSuggestions] = useState<Record<AISuggestionType, AISuggestionData | null>>({
  'photo-concern': null,
  'health-history': null,
  'report-draft': null,
  'weight-change': null,     // 追加
  'long-absence': null,      // 追加
  'birthday': null,          // 追加
  'follow-up': null,         // 追加
  'training-progress': null, // 追加
  'long-stay': null,         // 追加
});
```

---

## 検証方法

1. **体重変動アラート**
   - 前回と10%以上異なる体重を入力
   - サジェスションが表示されること

2. **久しぶりの来店**
   - 30日以上前の記録がある犬でカルテ作成
   - サジェスションが表示されること

3. **誕生日**
   - 誕生日が7日以内の犬でカルテ作成
   - お祝いサジェスションが表示されること

4. **前回の気になる点**
   - 前回のカルテにconcerns写真がある犬でカルテ作成
   - フォローアップサジェスションが表示されること

5. **トレーニング進捗**
   - 3回以上連続で同じ項目が「done」の犬でカルテ作成
   - 成長サジェスションが表示されること

6. **健康チェック異常**
   - 爪や皮膚などで2回連続異常の場合
   - 警告サジェスションが表示されること

7. **ホテル長期滞在**
   - 2泊以上のホテルカルテ作成時
   - 長期滞在サジェスションが表示されること

---

## 実装ステータス: ✅ 完了

すべてのサジェスション機能は実装済みです。
