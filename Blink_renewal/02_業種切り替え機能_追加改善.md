# 業種切り替え機能 追加改善計画

## 概要
前回実装した業種切り替え機能を拡張し、以下の改善を行う:
1. グルーミング → トリミングに名称変更
2. 顧客詳細画面に業態フィルタ追加
3. 業態別メッセージの出し分け
4. トリミング向けステータス最適化
5. 絵文字→アイコン置換（AI設定など）
6. AI設定のフッター対応
7. スタッフ権限管理（業種別アクセス制御）
8. 設定画面の業種別最適化

---

## 変更1: グルーミング → トリミングに名称変更

### 修正ファイル一覧
| ファイル | 変更内容 |
|----------|----------|
| `client/src/utils/businessTypeColors.ts` | `label: 'グルーミング'` → `'トリミング'` |
| `client/src/liff/pages/RecordList.tsx` | `label: 'グルーミング'` → `'トリミング'` |
| `client/src/liff/pages/RecordDetail.tsx` | `label: 'グルーミング'` → `'トリミング'` |
| `client/src/pages/RecordList.tsx` | `label: 'グルーミング'` → `'トリミング'` |
| `client/src/pages/Onboarding.tsx` | `description` 内の「グルーミング」→「トリミング」 |

---

## 変更2: 顧客詳細画面に業態フィルタ追加

### 2.1 バックエンド修正
**ファイル:** `server/src/routes/dogs.ts`

予約取得クエリに `service_type` を追加:
```sql
SELECT r.id, r.reservation_date, r.reservation_time, r.status, r.service_type, ...
```

### 2.2 型定義更新
**ファイル:** `client/src/hooks/useDogDetail.ts`

```typescript
interface DogReservationItem {
  // 既存フィールド...
  service_type?: string  // 追加
}
```

### 2.3 HistoryTabs修正
**ファイル:** `client/src/pages/HistoryTabs.tsx`

- Props に `selectedBusinessType` 追加
- 予約配列を `service_type` でフィルタリング

### 2.4 DogDetail統合
**ファイル:** `client/src/pages/DogDetail.tsx`

- `useBusinessTypeStore()` を使用
- `HistoryTabs` に業態フィルタを渡す

---

## 変更3: 業態別メッセージの出し分け

### 3.1 メッセージ定義ユーティリティ作成
**ファイル:** `client/src/utils/businessTypeMessages.ts`（新規）

```typescript
export const EMPTY_STATE_MESSAGES: Record<RecordType | 'all', EmptyStateConfig> = {
  daycare: {
    title: '今日の登園予定はありません',
    description: '新しい予約を追加して登園スケジュールを管理しましょう',
    actionLabel: '予約を追加',
  },
  grooming: {
    title: '今日の予約はありません',
    description: '新しい予約を追加してトリミングスケジュールを管理しましょう',
    actionLabel: '予約を追加',
  },
  hotel: {
    title: '今日のお預かり予定はありません',
    description: '新しい予約を追加してホテルスケジュールを管理しましょう',
    actionLabel: '予約を追加',
  },
  all: {
    title: '今日の予定はありません',
    description: '新しい予約を追加しましょう',
    actionLabel: '予約を追加',
  },
}

// ステータスラベルも業種別に
export const STATUS_LABELS: Record<RecordType, Record<string, string>> = {
  daycare: { '来店前': '登園前', '来店中': '登園中', '完了': '降園済' },
  grooming: { '来店前': '来店前', '完了': '来店済' },
  hotel: { '来店前': 'チェックイン前', '来店中': 'お預かり中', '完了': 'チェックアウト済' },
}
```

### 3.2 Dashboard.tsx修正
業態に応じた空状態メッセージを表示

---

## 変更4: トリミング向けステータス最適化

### 方針
- トリミングではステータス管理は不要（「来店前」「来店済」の2つのみ）
- 幼稚園/ホテルの複雑なステータス遷移は必要

### 実装
- トリミング選択時はステータス変更ボタンを非表示または簡略化
- ダッシュボードのステータス変更UIを業種別に出し分け
- 予約作成時もトリミングはステータス選択を省略

### ステータス対応表
| 業種 | ステータス |
|------|----------|
| 幼稚園 | 登園前 → 登園中 → 降園済 |
| トリミング | 来店前 → 来店済（完了） |
| ホテル | チェックイン前 → お預かり中 → チェックアウト済 |

---

## 変更5: 絵文字 → アイコン置換

### 修正ファイル一覧
| ファイル | 行 | 変更内容 |
|----------|-----|----------|
| `AISettingsScreen.tsx` | 76 | `🔮` → `<Icon icon="solar:magic-stick-3-bold" />` |
| `AISuggestion.tsx` | 71 | `🔮` → `<Icon icon="solar:magic-stick-3-bold" />` |
| `Billing.tsx` | 223 | `⚠️` → `<Icon icon="solar:danger-triangle-bold" />` |

---

## 変更6: AI設定のフッター対応

**ファイル:** `client/src/pages/records/components/AISettingsScreen.tsx`

### 問題
- ボトムシートのフッターがタップしにくい
- iPhoneのセーフエリアを考慮していない

### 修正
```tsx
{/* Footer - セーフエリア対応 */}
<div className="px-5 pb-5 pt-2 border-t border-slate-100 flex gap-3"
     style={{ paddingBottom: 'max(20px, env(safe-area-inset-bottom))' }}>
```

---

## 変更7: スタッフ権限管理（業種別アクセス制御）

### 7.1 データベース拡張
**テーブル:** `staff` に `assigned_business_types` カラム追加

```sql
ALTER TABLE staff ADD COLUMN assigned_business_types TEXT[] DEFAULT NULL;
-- NULL = 全業種アクセス可（管理者）
-- ['daycare'] = 幼稚園のみ
-- ['daycare', 'grooming'] = 複数業種
```

### 7.2 バックエンドAPI修正
**ファイル:** `server/src/routes/auth.ts`

`/auth/me` レスポンスに `assignedBusinessTypes` 追加

### 7.3 フロントエンド認証ストア更新
**ファイル:** `client/src/store/authStore.ts`

```typescript
interface StaffUser {
  // 既存フィールド...
  assignedBusinessTypes?: RecordType[] | null  // 追加（null=全業種）
}
```

### 7.4 業種スイッチャー制御
**ファイル:** `client/src/components/BusinessTypeSwitcher.tsx`

- `assignedBusinessTypes` に基づいて選択可能な業種を制限
- 管理者（`isOwner: true`）は全業種選択可能
- 一般スタッフは割り当てられた業種のみ

### 7.5 スタッフ招待画面修正
**ファイル:** `client/src/pages/settings/StoreTab.tsx`

スタッフ招待時に業種を指定できるUI追加

---

## 変更8: 設定画面の業種別最適化

**ファイル:** `client/src/pages/settings/StoreTab.tsx`

### 業種別表示/非表示ルール
| 設定項目 | daycare | grooming | hotel |
|----------|:-------:|:--------:|:-----:|
| 受入可能頭数 | ✓ | ✗ | ✗ |
| 登園用QRコード | ✓ | ✗ | ✗ |
| AI設定 | ✓ | ✓ | ✓ |
| トレーニング項目 | ✓ | ✗ | ✗ |

### 実装
```typescript
const { selectedBusinessType } = useBusinessTypeStore()

// 受入可能頭数セクション
{(!selectedBusinessType || selectedBusinessType === 'daycare') && (
  <section>受入可能頭数...</section>
)}
```

---

## 修正対象ファイル一覧

### クライアント側
| ファイル | 操作 |
|----------|------|
| `client/src/utils/businessTypeColors.ts` | 修正（トリミング名称）|
| `client/src/utils/businessTypeMessages.ts` | 新規作成 |
| `client/src/liff/pages/RecordList.tsx` | 修正（トリミング名称）|
| `client/src/liff/pages/RecordDetail.tsx` | 修正（トリミング名称）|
| `client/src/pages/RecordList.tsx` | 修正（トリミング名称）|
| `client/src/pages/Onboarding.tsx` | 修正（トリミング名称）|
| `client/src/hooks/useDogDetail.ts` | 修正（型追加）|
| `client/src/pages/HistoryTabs.tsx` | 修正（フィルタ追加）|
| `client/src/pages/DogDetail.tsx` | 修正（フィルタ連携）|
| `client/src/pages/Dashboard.tsx` | 修正（メッセージ出し分け）|
| `client/src/pages/records/components/AISettingsScreen.tsx` | 修正（絵文字・フッター）|
| `client/src/pages/records/components/AISuggestion.tsx` | 修正（絵文字）|
| `client/src/pages/Billing.tsx` | 修正（絵文字）|
| `client/src/store/authStore.ts` | 修正（権限追加）|
| `client/src/components/BusinessTypeSwitcher.tsx` | 修正（権限制御）|
| `client/src/pages/settings/StoreTab.tsx` | 修正（業種別表示・スタッフ招待）|

### サーバー側
| ファイル | 操作 |
|----------|------|
| `server/src/routes/dogs.ts` | 修正（service_type追加）|
| `server/src/routes/auth.ts` | 修正（assignedBusinessTypes追加）|

### データベース
```sql
ALTER TABLE staff ADD COLUMN assigned_business_types TEXT[] DEFAULT NULL;
```

---

## 検証方法

1. **名称変更**
   - 全画面で「トリミング」と表示されること

2. **顧客詳細フィルタ**
   - 業種選択後、その業種の予約履歴のみ表示

3. **業態別メッセージ**
   - 幼稚園選択時：「登園スケジュール」などの文言
   - トリミング選択時：「トリミングスケジュール」などの文言

4. **絵文字→アイコン**
   - AI設定画面で絵文字がアイコンに変わっていること

5. **AI設定フッター**
   - iPhoneでボタンがタップしやすいこと

6. **スタッフ権限**
   - 一般スタッフが割り当て業種のみ選択可能
   - 管理者は全業種選択可能

7. **設定画面**
   - トリミング選択時に受入可能頭数が非表示
