# 追加仕様: 業種切り替え機能リニューアル

作成日: 2026-02-05

## 背景

現状のUIフローでは、カルテ画面でのみ業種の切り替えが可能だが、ダッシュボード・予定・顧客・設定など全ての画面を業種ごとに切り替えて使用したい。Freeeのようなサービス切り替えUIをイメージ。

---

## 要件

### 1. グローバル業種切り替え機能

- ダッシュボード右上のアバターアイコンをクリックすると業種切り替えメニューを表示
- 選択肢:
  - すべての業種
  - 🌞 幼稚園 (daycare)
  - ✂️ グルーミング (grooming)
  - 🌙 ホテル (hotel)
- 切り替えると紐づく画面も全てその業種のものに切り替わる
- 予定や顧客の親テーブルは共通だが、選択した業種のフラグがついているものだけ表示

### 2. 設定画面での業種切り替え機能は不要

- 設定画面からの業種切り替え機能を削除
- 業種設定はオンボーディング時のみ

### 3. 幼稚園連絡帳の便・食事記録復元

コミット7131a13で削除された以下の機能を復元:

#### 食事記録
```typescript
meal?: {
  morning?: string    // 朝ごはん
  afternoon?: string  // 昼ごはん
}
```

#### 排便記録
```typescript
toilet?: {
  morning?: { urination: boolean; defecation: boolean }
  afternoon?: { urination: boolean; defecation: boolean }
}
```

---

## 技術仕様

### フロントエンド

#### 新規作成ファイル
- `client/src/store/businessTypeStore.ts` - Zustand業種状態管理
- `client/src/components/BusinessTypeSwitcher.tsx` - 業種スイッチャーUI

#### 修正ファイル
| ファイル | 変更内容 |
|----------|----------|
| `client/src/components/Layout.tsx` | アバター→BusinessTypeSwitcher |
| `client/src/pages/Dashboard.tsx` | service_typeフィルタ追加 |
| `client/src/pages/ReservationsCalendar.tsx` | service_typeフィルタ追加 |
| `client/src/pages/Customers.tsx` | service_typeフィルタ追加 |
| `client/src/pages/settings/StoreTab.tsx` | 業種設定セクション削除 |
| `client/src/pages/records/components/DaycareForm.tsx` | 便・食事記録UI復元 |

### バックエンド

#### 修正ファイル
| ファイル | 変更内容 |
|----------|----------|
| `server/src/routes/dashboard.ts` | service_typeクエリパラメータ対応 |
| `server/src/routes/reservations.ts` | service_typeクエリパラメータ対応 |
| `server/src/routes/owners.ts` | 予約履歴のservice_typeでJOINフィルタ |

---

## 状態管理設計

```typescript
// businessTypeStore.ts
interface BusinessTypeState {
  selectedBusinessType: RecordType | null  // null = 全業種表示
  setSelectedBusinessType: (type: RecordType | null) => void
}

// Zustand persist でlocalStorageに永続化
// ログイン時にprimaryBusinessTypeを初期値として設定
```

---

## UI設計

### 業種スイッチャー（ドロップダウン）

```
[アバターアイコンをクリック]
    ↓
┌─────────────────────────┐
│ すべての業種      ✓     │
├─────────────────────────┤
│ 🌞 幼稚園               │
│ ✂️ グルーミング         │
│ 🌙 ホテル               │
└─────────────────────────┘
```

- 選択中の業種はアイコンと色で視覚的に表示
- ユーザーが1業種のみの場合はスイッチャー無効化

---

## データフィルタリングロジック

### 予約・カルテ
- `reservations.service_type` = 選択業種
- `records.record_type` = 選択業種

### 顧客
- 顧客自体は業種フラグを持たない
- 選択された業種の予約履歴を持つ犬の飼い主のみを表示
- サーバー側でJOINクエリを使用してフィルタリング

```sql
SELECT DISTINCT o.* FROM owners o
JOIN dogs d ON d.owner_id = o.id
JOIN reservations r ON r.dog_id = d.id
WHERE r.service_type = $1
```

---

## 検証チェックリスト

- [ ] ダッシュボード右上アイコンクリックでメニュー表示
- [ ] 業種選択後、ダッシュボードがフィルタリングされる
- [ ] 業種選択後、予定画面がフィルタリングされる
- [ ] 業種選択後、顧客画面がフィルタリングされる
- [ ] ページ遷移しても選択状態が維持される
- [ ] 設定画面から業種切り替え機能が削除されている
- [ ] 幼稚園連絡帳で食事記録が入力可能
- [ ] 幼稚園連絡帳で排便記録が入力可能
