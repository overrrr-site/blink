# 飼い主向け機能強化: カルテ配信改善 + LIFF業種別最適化 + 事前入力業種別対応

## 概要
飼い主（ペットオーナー）との接点を強化する3つの機能改善を実施する。
カルテ共有フローの改善、LIFF画面の業種別最適化、事前入力フォームの業種別対応。

---

## 現状分析

### カルテLINE共有
- `RecordDetail.tsx:222` に「飼い主に送信」ボタン ✅ 実装済
- `records.ts:524-546` で `shared_at` 更新 + LINE通知送信 ✅ 実装済
- `lineFlexMessages.ts:454` で業種別カラーのFlexメッセージ ✅ 実装済
- `notificationService.ts:371` で通知配信ロジック ✅ 実装済

**課題**:
- 保存後に自動で共有する設定がない（毎回手動で「飼い主に送信」を押す必要）
- RecordCreate（新規作成画面）から直接共有できない（保存→詳細画面→共有の2ステップ）
- 共有済みカルテの一覧表示がない（どれを共有したか把握しにくい）

### LIFF飼い主アプリ
- `liff/pages/RecordDetail.tsx` でカルテ詳細表示 ✅ 実装済
- 業種別のデータ表示あり（grooming_data, daycare_data, hotel_data）

**課題**:
- 全業種で同じレイアウト構造。トリミング固有の表示（ビフォーアフター写真比較等）がない
- ホテルの日別レポート表示がフラット。滞在日ごとの時系列表示がない
- 写真のズーム表示機能がない

### 事前入力（Pre-Visit Input）
- `preVisitInputs.ts` で排泄・食事・体調のフォーム ✅ 実装済
- `liff/pages/PreVisitInput.tsx` でLIFF画面 ✅ 実装済

**課題**:
- **幼稚園（daycare）専用のフォーム**になっている（`morning_urination`, `breakfast_status` 等）
- トリミング予約時の事前入力がない（スタイル希望、気になる箇所、前回からの変化等）
- ホテル予約時の事前入力がない（食事スケジュール、投薬情報、散歩の好み等）
- 業種による表示切り替えがない（`service_type`を参照していない）

---

## 1. カルテ配信フロー改善

### 1-1. 保存後自動共有設定

店舗設定に「カルテ保存時に自動で飼い主に共有」フラグを追加。

#### DB変更
```sql
-- notification_settings に auto_share_record カラム追加
ALTER TABLE notification_settings
  ADD COLUMN IF NOT EXISTS auto_share_record BOOLEAN DEFAULT false;
```

#### バックエンド（`server/src/routes/records.ts`）
レコード作成・更新の保存処理後に、auto_share_record 設定を確認して自動共有:

```typescript
// POST /records (create) と PUT /records/:id (update) の保存成功後に:
if (status === 'saved') {
  const settings = await pool.query(
    `SELECT auto_share_record FROM notification_settings WHERE store_id = $1`,
    [req.storeId]
  );
  if (settings.rows[0]?.auto_share_record) {
    // 自動共有処理（既存のshareロジックを関数化して再利用）
    await autoShareRecord(req.storeId, recordId);
  }
}
```

#### フロントエンド
- `settings/StoreTab.tsx` にトグル追加:「カルテ保存時に自動で飼い主に送信」
- `RecordCreate.tsx` に「保存して送信」ボタン追加（保存 + 共有を1アクション）

### 1-2. カルテ一覧の共有ステータス表示

`RecordList.tsx` で共有済み/未共有をバッジ表示:

```typescript
{record.shared_at ? (
  <span className="text-xs text-green-600 bg-green-50 px-2 py-0.5 rounded-full">送信済</span>
) : record.status === 'saved' ? (
  <span className="text-xs text-amber-600 bg-amber-50 px-2 py-0.5 rounded-full">未送信</span>
) : null}
```

---

## 2. LIFF業種別レイアウト最適化

### 2-1. トリミングカルテ詳細の強化

`client/src/liff/pages/RecordDetail.tsx` のトリミングセクションを拡充:

```typescript
{record.record_type === 'grooming' && record.grooming_data && (
  <>
    {/* 施術箇所のビジュアル表示 */}
    <section className="bg-card rounded-2xl p-4 space-y-3">
      <h3 className="font-bold text-sm">施術内容</h3>
      <div className="grid grid-cols-2 gap-2">
        {record.grooming_data.selectedParts.map(part => (
          <div key={part} className="bg-muted/50 rounded-xl p-3">
            <p className="text-xs font-medium text-muted-foreground">{PART_LABELS[part]}</p>
            <p className="text-sm mt-1">{record.grooming_data.partNotes[part] || '施術済み'}</p>
          </div>
        ))}
      </div>
    </section>

    {/* ビフォーアフター写真 */}
    {hasBothBeforeAfter && (
      <section className="bg-card rounded-2xl p-4 space-y-3">
        <h3 className="font-bold text-sm">ビフォーアフター</h3>
        <div className="grid grid-cols-2 gap-3">
          <div>
            <p className="text-xs text-center text-muted-foreground mb-1">Before</p>
            <LazyImage src={beforePhoto} className="rounded-xl aspect-square object-cover" />
          </div>
          <div>
            <p className="text-xs text-center text-muted-foreground mb-1">After</p>
            <LazyImage src={afterPhoto} className="rounded-xl aspect-square object-cover" />
          </div>
        </div>
      </section>
    )}
  </>
)}
```

### 2-2. ホテルカルテの日別タイムライン

```typescript
{record.record_type === 'hotel' && record.hotel_data && (
  <section className="bg-card rounded-2xl p-4 space-y-3">
    <h3 className="font-bold text-sm">
      お預かりレポート（{record.hotel_data.nights}泊）
    </h3>
    <div className="space-y-4">
      {Object.entries(record.hotel_data.daily_notes || {}).map(([date, note]) => (
        <div key={date} className="border-l-2 border-primary/30 pl-3">
          <p className="text-xs font-medium text-muted-foreground">
            {format(new Date(date), 'M月d日(E)', { locale: ja })}
          </p>
          <p className="text-sm mt-1">{note}</p>
        </div>
      ))}
    </div>
  </section>
)}
```

### 2-3. 写真ズーム表示

全業種共通で、写真タップ時にモーダルでフルサイズ表示:

```typescript
// 新規コンポーネント: client/src/liff/components/PhotoViewer.tsx
function PhotoViewer({ photos, initialIndex, onClose }) {
  // スワイプ対応の全画面写真ビューア
}
```

---

## 3. 事前入力（Pre-Visit Input）の業種別対応

### 3-1. DB変更

```sql
-- pre_visit_inputs に業種別フィールド追加
ALTER TABLE pre_visit_inputs
  ADD COLUMN IF NOT EXISTS service_type VARCHAR(20),
  ADD COLUMN IF NOT EXISTS grooming_data JSONB,  -- トリミング用事前入力
  ADD COLUMN IF NOT EXISTS hotel_data JSONB;      -- ホテル用事前入力
```

※ migrationの作成が必要（カラム追加のみ）

### 3-2. 業種別フォームデータ構造

```typescript
// トリミング用事前入力
interface GroomingPreVisitData {
  style_preference?: string        // スタイル希望（前回と同じ / おまかせ / 具体的なリクエスト）
  style_notes?: string             // 具体的なスタイル希望メモ
  concern_areas?: string[]         // 気になる箇所（ears, skin, nails, teeth, eyes）
  concern_notes?: string           // 気になる点の詳細
  changes_since_last?: string      // 前回からの変化
  skin_issues?: boolean            // 皮膚トラブルの有無
}

// ホテル用事前入力
interface HotelPreVisitData {
  feeding_schedule?: {
    morning?: string    // 朝ごはんの時間・内容
    evening?: string    // 夜ごはんの時間・内容
    snack?: string      // おやつ
  }
  medication?: {
    has_medication: boolean
    details?: string    // 投薬の詳細（薬名・タイミング）
  }
  walk_preference?: string          // 散歩の好み（朝のみ / 朝夕 / 必要なし）
  sleeping_habit?: string           // 寝る時の癖（ケージ / フリー等）
  special_notes?: string            // その他の特記事項
  emergency_contact_confirmed?: boolean  // 緊急連絡先の確認
}
```

### 3-3. バックエンド（`server/src/routes/preVisitInputs.ts`）✅ 実装済

POST エンドポイントは既に拡張済み。`service_type`, `grooming_data`, `hotel_data` を受け取り、
`parseBusinessTypeInput` でバリデーション後に保存する:

```typescript
const {
  reservation_id,
  service_type,        // 追加済み
  // 幼稚園（既存）
  morning_urination, morning_defecation,
  afternoon_urination, afternoon_defecation,
  breakfast_status, health_status, notes, meal_data,
  // 新規
  grooming_data,       // トリミング用
  hotel_data,          // ホテル用
} = req.body;
```

### 3-4. LIFF画面（`client/src/liff/pages/PreVisitInput.tsx`）

予約の`service_type`に応じてフォームを切り替え:

```typescript
// 予約データからservice_typeを取得
const serviceType = reservation?.service_type || 'daycare'

return (
  <div>
    {serviceType === 'daycare' && <DaycarePreVisitForm />}
    {serviceType === 'grooming' && <GroomingPreVisitForm />}
    {serviceType === 'hotel' && <HotelPreVisitForm />}
  </div>
)
```

#### トリミング用フォーム
```typescript
function GroomingPreVisitForm() {
  return (
    <>
      {/* スタイル希望 */}
      <section>
        <h3>ご希望のスタイル</h3>
        <RadioGroup options={['前回と同じ', 'おまかせ', '具体的なリクエストあり']} />
        {showNotes && <textarea placeholder="具体的なご要望..." />}
      </section>

      {/* 気になる箇所 */}
      <section>
        <h3>気になる箇所はありますか？</h3>
        <CheckboxGroup options={['耳', '皮膚', '爪', '歯', '目', 'その他']} />
        <textarea placeholder="詳細を教えてください..." />
      </section>

      {/* 前回からの変化 */}
      <section>
        <h3>前回のご利用から変わったことはありますか？</h3>
        <textarea placeholder="例: 最近かゆがっている、薬を飲み始めた等" />
      </section>
    </>
  )
}
```

#### ホテル用フォーム
```typescript
function HotelPreVisitForm() {
  return (
    <>
      {/* 食事 */}
      <section>
        <h3>食事について</h3>
        <input placeholder="朝ごはん（時間・内容）" />
        <input placeholder="夜ごはん（時間・内容）" />
        <input placeholder="おやつ" />
      </section>

      {/* 投薬 */}
      <section>
        <h3>お薬</h3>
        <RadioGroup options={['なし', 'あり']} />
        {hasMedication && <textarea placeholder="薬名・タイミング..." />}
      </section>

      {/* お散歩 */}
      <section>
        <h3>お散歩の希望</h3>
        <RadioGroup options={['朝のみ', '朝夕', 'お散歩不要']} />
      </section>

      {/* その他 */}
      <section>
        <h3>寝る時の習慣</h3>
        <RadioGroup options={['ケージ', 'フリー', 'どちらでも']} />
      </section>

      <section>
        <h3>その他の特記事項</h3>
        <textarea placeholder="スタッフに伝えておきたいこと..." />
      </section>
    </>
  )
}
```

### 3-5. LIFF API（`server/src/routes/liff/preVisitInputs.ts`）

LIFF側のAPIも業種別データに対応。予約から`service_type`を取得して返却:

```typescript
// 予約情報取得時にservice_typeを含める
const result = await pool.query(
  `SELECT r.id, r.dog_id, d.name as dog_name,
          r.reservation_date, r.reservation_time,
          r.service_type,  -- 追加
          pvi.*
   FROM reservations r
   JOIN dogs d ON r.dog_id = d.id
   LEFT JOIN pre_visit_inputs pvi ON pvi.reservation_id = r.id
   WHERE r.id = $1 AND r.store_id = $2`,
  [reservationId, storeId]
);
```

---

## 対象ファイル

### バックエンド
| ファイル | 変更内容 |
|----------|----------|
| `server/src/routes/records.ts` | 自動共有ロジック追加 |
| `server/src/routes/preVisitInputs.ts` | 業種別フィールド対応 ✅ 実装済 |
| `server/src/routes/liff/preVisitInputs.ts` | LIFF API業種対応 |
| `server/src/routes/storeSettings.ts` | auto_share_record設定追加 |
| 新規migration | pre_visit_inputs拡張、notification_settings拡張 |

### フロントエンド（管理画面）
| ファイル | 変更内容 |
|----------|----------|
| `client/src/pages/RecordCreate.tsx` | 「保存して送信」ボタン |
| `client/src/pages/RecordList.tsx` | 共有ステータスバッジ |
| `client/src/pages/settings/StoreTab.tsx` | 自動共有トグル |

### フロントエンド（LIFF）
| ファイル | 変更内容 |
|----------|----------|
| `client/src/liff/pages/RecordDetail.tsx` | 業種別レイアウト最適化 |
| `client/src/liff/pages/PreVisitInput.tsx` | 業種別フォーム分岐 |
| 新規: `client/src/liff/components/PhotoViewer.tsx` | 写真ズームビューア |

---

## 検証チェックリスト

### カルテ配信
- [ ] 自動共有設定をONにした状態でカルテを保存し、自動でLINE通知が送信されること
- [ ] RecordCreateから「保存して送信」で1アクションで共有できること
- [ ] RecordListで共有済み/未送信のバッジが正しく表示されること
- [ ] 自動共有設定をOFFにした状態では手動のみであること

### LIFF業種別
- [ ] トリミングカルテで施術箇所がグリッド表示されること
- [ ] ホテルカルテで日別タイムライン表示されること
- [ ] 写真タップでズーム表示されること
- [ ] 各業種のレイアウトがモバイルで崩れないこと（360px幅で確認）

### 事前入力
- [ ] トリミング予約で「スタイル希望」「気になる箇所」フォームが表示されること
- [ ] ホテル予約で「食事」「投薬」「散歩」フォームが表示されること
- [ ] 幼稚園予約では既存の排泄・食事フォームが表示されること
- [ ] 保存した事前入力データがスタッフ画面から確認できること

---

## 実装ステータス

### カルテ配信
- [x] 飼い主への送信ボタン ✅
- [x] LINE Flexメッセージ（業種別カラー）✅
- [x] shared_at ステータス管理 ✅
- [ ] 自動共有設定（auto_share_record）📋
- [ ] RecordCreateから直接共有 📋
- [ ] RecordListの共有ステータス表示 📋

### LIFF業種別
- [x] カルテ詳細基本表示 ✅
- [x] 業種別データ表示（grooming/daycare/hotel）✅
- [ ] トリミング施術箇所ビジュアル表示 📋
- [ ] ビフォーアフター写真比較 📋
- [ ] ホテル日別タイムライン 📋
- [ ] 写真ズームビューア 📋

### 事前入力
- [x] 幼稚園用フォーム（排泄・食事・体調）✅
- [x] バックエンドAPI（service_type, grooming_data, hotel_data 対応）✅
- [ ] DBマイグレーション（pre_visit_inputsカラム追加）📋
- [ ] トリミング用LIFFフォーム（スタイル・気になる箇所）📋
- [ ] ホテル用LIFFフォーム（食事・投薬・散歩）📋
- [ ] service_type による表示切り替え 📋
