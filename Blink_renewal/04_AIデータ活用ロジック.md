# AI データ活用ロジック計画

## 概要
店舗ごとにAI出力の品質を継続的に改善するためのデータ活用システム。
ユーザーのフィードバックを収集し、店舗の好みに合ったレポートを生成できるようにする。

---

## 設定フラグ

| フラグ | 説明 | デフォルト |
|--------|------|-----------|
| `ai_store_data_contribution` | 店舗内でのAI学習データ蓄積 | `true` |
| `ai_service_improvement` | サービス全体の改善のためのデータ共有（将来用） | `false` |

---

## 実装コンポーネント

### 1. データベース: `ai_learning_data` テーブル

```sql
CREATE TABLE ai_learning_data (
  id SERIAL PRIMARY KEY,
  store_id INTEGER NOT NULL REFERENCES stores(id),

  -- データの種類
  data_type VARCHAR(50) NOT NULL, -- 'report_generation', 'photo_analysis', 'suggestion_feedback'

  -- 入力データ（匿名化済み）
  input_context JSONB,

  -- 出力データ
  ai_output TEXT,

  -- ユーザーフィードバック
  was_used BOOLEAN DEFAULT NULL,
  was_edited BOOLEAN DEFAULT NULL,
  final_text TEXT,

  -- メタデータ
  record_type VARCHAR(20),
  quality_score DECIMAL(3,2),

  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### 2. 品質スコアの定義

| ユーザーの行動 | スコア | 意味 |
|---------------|--------|------|
| そのまま採用 | 1.0 | 高品質（完璧） |
| 編集して使用 | 0.7 | 良い（微調整が必要） |
| 使用しなかった | 0.2 | 改善が必要 |

### 3. データ活用の流れ

```
1. AI生成リクエスト
     ↓
2. 過去の高品質データを検索
     ↓
3. 店舗の文体パターンを分析
     ↓
4. プロンプトに反映
     ↓
5. AI出力を生成
     ↓
6. 学習データとして保存
     ↓
7. ユーザーのフィードバックを記録
     ↓
8. 次回の生成に活用
```

---

## ユーティリティ関数

### `server/src/utils/aiLearning.ts`

```typescript
// AI設定を取得
getAISettings(storeId: number): Promise<AISettings>

// 学習データを保存（匿名化処理込み）
saveAILearningData(input: AILearningInput): Promise<number | null>

// フィードバックを記録
recordAIFeedback(input: AIFeedbackInput): Promise<void>

// 高品質な過去例を取得
getHighQualityExamples(
  storeId: number,
  dataType: AIDataType,
  recordType?: string,
  limit?: number
): Promise<Example[]>

// 文体パターンを分析
analyzeWritingStyle(storeId: number, recordType?: string): Promise<WritingStyle | null>

// サジェスションのフィードバックを記録
recordSuggestionFeedback(
  storeId: number,
  suggestionType: string,
  wasApplied: boolean,
  recordType?: string
): Promise<void>
```

---

## 匿名化処理

プライバシー保護のため、以下の情報は匿名化して保存：

| 元データ | 匿名化後 |
|----------|---------|
| 犬の名前 | `[DOG_NAME]` |
| 飼い主名 | `[OWNER_NAME]` |
| メモ内容 | `[MEMO_EXISTS:100chars]` |
| 写真URL | `[PHOTO_EXISTS]` |
| 固有名詞（○○ちゃん） | `[NAME]` |

---

## 文体パターン分析

過去20件の高品質レポートから以下を分析：

1. **平均文字数**: 詳しく書くか簡潔に書くか
2. **絵文字使用率**: 絵文字を使うか控えめか
3. **フォーマルレベル**: casual / formal / mixed

分析結果をプロンプトに追加：
```
【この店舗の好みの文体】
詳しく丁寧に、絵文字は控えめに、親しみやすい口調で書いてください。
```

---

## APIエンドポイント

### `POST /ai/feedback`
AI出力へのフィードバックを記録

```json
{
  "learning_data_id": 123,
  "was_used": true,
  "was_edited": false,
  "final_text": "実際に使用されたテキスト"
}
```

### `POST /ai/suggestion-feedback`
サジェスションへのフィードバックを記録

```json
{
  "suggestion_type": "birthday",
  "was_applied": true,
  "record_type": "grooming"
}
```

### `GET /ai/settings`
AI設定を取得

---

## 将来的な拡張（RAG方式へのアップグレード）

現在の実装は「シンプルな学習システム」。
将来的に `pgvector` を導入してRAG方式にアップグレード可能：

1. レポートのベクトル埋め込みを生成
2. 類似度検索で関連する過去レポートを取得
3. より精度の高いコンテキスト選択

---

## 実装ステータス: ✅ 完了

- [x] `ai_learning_data` テーブル作成
- [x] `aiLearning.ts` ユーティリティ作成
- [x] レポート生成への文体パターン反映
- [x] フィードバックエンドポイント追加
- [ ] フロントエンドでのフィードバック送信（未実装）
- [ ] RAG方式へのアップグレード（将来）
